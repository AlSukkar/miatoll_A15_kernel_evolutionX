name: Integrate SUSFS into Kernel Repo

on:
  workflow_dispatch:

jobs:
  integrate-susfs:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout kernel vic branch
        uses: actions/checkout@v4
        with:
          repository: AlSukkar/kernel_xiaomi_sm6250
          ref: vic
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          fetch-depth: 0
      
      - name: Configure Git
        run: |
          git config user.name "AlSukkar"
          git config user.email "your-email@example.com"
      
      - name: Remove outdated KernelSU-Next folder
        run: |
          if [ -d "KernelSU-Next" ]; then
            rm -rf KernelSU-Next
            git add .
            git commit -m "Remove outdated KernelSU-Next" || echo "Already removed"
          fi
      
      - name: Setup KernelSU-Next v1.1.1
        run: |
          curl -LSs "https://raw.githubusercontent.com/rifsxd/KernelSU-Next/next/kernel/setup.sh" | bash -s v1.1.1
      
      - name: Download and apply SUSFS v1.5.3 patch to KernelSU-Next
        run: |
          cd KernelSU-Next/
          curl -o 0001-Kernel-Implement-SUSFS-v1.5.3.patch https://github.com/sidex15/KernelSU-Next/commit/1e750de25930e875612bbec0410de0088474c00b.patch
          patch -p1 < 0001-Kernel-Implement-SUSFS-v1.5.3.patch
          rm 0001-Kernel-Implement-SUSFS-v1.5.3.patch
          cd ..
      
      - name: Clone SUSFS kernel 4.14 patches
        run: |
          git clone https://gitlab.com/simonpunk/susfs4ksu.git -b kernel-4.14 susfs4ksu
      
      - name: Copy SUSFS kernel patches
        run: |
          echo "Copying SUSFS patches to kernel directories..."
          mkdir -p fs include/linux
          cp -v susfs4ksu/kernel_patches/fs/* fs/ 2>/dev/null || echo "No fs patches"
          cp -v susfs4ksu/kernel_patches/include/linux/* include/linux/ 2>/dev/null || echo "No include patches"
      
      - name: Apply main SUSFS kernel patch
        run: |
          if [ -f "susfs4ksu/kernel_patches/50_add_susfs_in_kernel-4.14.patch" ]; then
            cp susfs4ksu/kernel_patches/50_add_susfs_in_kernel-4.14.patch .
            patch -p1 < 50_add_susfs_in_kernel-4.14.patch || echo "Patch may already be applied"
            rm 50_add_susfs_in_kernel-4.14.patch
          fi
      
      - name: Cleanup temporary SUSFS repo
        run: |
          rm -rf susfs4ksu
      
      - name: Commit all changes
        run: |
          git add .
          git commit -m "Update to KernelSU-Next v1.1.1 with SUSFS v1.5.3 integration for kernel 4.14" || echo "No changes to commit"
      
      - name: Push to vic branch
        run: |
          git push origin vic
