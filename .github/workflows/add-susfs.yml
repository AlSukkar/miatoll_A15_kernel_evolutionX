name: Correct SUSFS Integration for Kernel 4.14

on:
  workflow_dispatch:

jobs:
  fix-susfs:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout vic branch
        uses: actions/checkout@v4
        with:
          repository: AlSukkar/kernel_xiaomi_sm6250
          ref: vic
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          fetch-depth: 0
      
      - name: Configure Git
        run: |
          git config user.name "AlSukkar"
          git config user.email "alsukkar@users.noreply.github.com"
      
      - name: Remove everything and start fresh
        run: |
          # Remove KernelSU-Next with wrong SUSFS
          rm -rf KernelSU-Next
          
          # Remove any SUSFS files that were added
          rm -f fs/sus*.c
          rm -f include/linux/sus*.h
          
          git add -A
          git commit -m "Clean up incorrect SUSFS integration" || echo "Nothing to clean"
      
      - name: Setup clean KernelSU-Next v1.1.1 (WITHOUT SUSFS patch)
        run: |
          curl -LSs "https://raw.githubusercontent.com/rifsxd/KernelSU-Next/next/kernel/setup.sh" | bash -s v1.1.1
          
          # Remove .git to make it a regular directory
          rm -rf KernelSU-Next/.git
          
          echo "‚úÖ Clean KernelSU-Next v1.1.1 installed (NO SUSFS in KernelSU yet)"
      
      - name: Clone SUSFS kernel 4.14 patches ONLY
        run: |
          git clone https://gitlab.com/simonpunk/susfs4ksu.git -b kernel-4.14 susfs4ksu
      
      - name: Apply ONLY the kernel-4.14 specific patches
        run: |
          echo "üìÅ Copying kernel 4.14 SUSFS files..."
          
          # Copy kernel source patches
          mkdir -p fs include/linux
          
          if [ -d "susfs4ksu/kernel_patches/fs" ]; then
            cp -v susfs4ksu/kernel_patches/fs/* fs/
          fi
          
          if [ -d "susfs4ksu/kernel_patches/include/linux" ]; then
            cp -v susfs4ksu/kernel_patches/include/linux/* include/linux/
          fi
          
          # Apply the 4.14 specific patch
          if [ -f "susfs4ksu/kernel_patches/50_add_susfs_in_kernel-4.14.patch" ]; then
            echo "üîß Applying kernel 4.14 patch..."
            patch -p1 < susfs4ksu/kernel_patches/50_add_susfs_in_kernel-4.14.patch || {
              echo "‚ö†Ô∏è Some hunks failed, checking critical changes..."
              # Continue anyway - we'll fix manually if needed
            }
          fi
          
          # Clean up
          rm -rf susfs4ksu
          find . -name "*.rej" -delete
          find . -name "*.orig" -delete
      
      - name: Verify NO bad references exist
        run: |
          echo "üîç Checking for problematic code..."
          
          if grep -r "INODE_STATE_SUS_KSTAT" fs/proc/ 2>/dev/null; then
            echo "‚ùå ERROR: task_mmu.c still has INODE_STATE_SUS_KSTAT - this shouldn't be there!"
            echo "Removing it..."
            # Remove the problematic lines from task_mmu.c
            if [ -f "fs/proc/task_mmu.c" ]; then
              sed -i '/INODE_STATE_SUS_KSTAT/d' fs/proc/task_mmu.c
            fi
          fi
          
          echo "‚úÖ Verification complete"
      
      - name: Fix kernel_compat.c duplicate if exists
        run: |
          FILE="KernelSU-Next/kernel/kernel_compat.c"
          if [ -f "$FILE" ]; then
            # Count ksu_access_ok definitions
            COUNT=$(grep -c "int ksu_access_ok" "$FILE" || echo "0")
            if [ "$COUNT" -gt "1" ]; then
              echo "üîß Fixing duplicate ksu_access_ok..."
              # Keep only the first definition (around line 79)
              # Remove the static inline one (around line 187)
              awk '/^static inline int ksu_access_ok/{skip=1} skip && /^}$/{skip=0; next} !skip' "$FILE" > "$FILE.tmp"
              mv "$FILE.tmp" "$FILE"
            fi
          fi
      
      - name: Show integration summary
        run: |
          echo "üìä SUSFS Integration for Kernel 4.14:"
          echo "====================================="
          echo "‚úÖ KernelSU-Next v1.1.1 (clean, no SUSFS inside)"
          [ -f "fs/susfs.c" ] && echo "‚úÖ fs/susfs.c" || echo "‚ùå fs/susfs.c missing"
          [ -f "fs/sus_su.c" ] && echo "‚úÖ fs/sus_su.c" || echo "‚ùå fs/sus_su.c missing"
          [ -f "include/linux/susfs.h" ] && echo "‚úÖ include/linux/susfs.h" || echo "‚ùå missing"
          
          echo ""
          echo "Checking for errors:"
          ! grep -q "INODE_STATE_SUS_KSTAT" fs/proc/task_mmu.c 2>/dev/null && echo "‚úÖ No task_mmu.c issues" || echo "‚ùå task_mmu.c still has issues"
      
      - name: Commit corrected integration
        run: |
          git add -A
          git commit -m "Correct SUSFS integration for kernel 4.14

          - KernelSU-Next v1.1.1 without SUSFS patches (clean)
          - Applied only kernel-4.14 specific SUSFS patches
          - Removed incompatible SUSFS code for newer kernels
          - Fixed kernel_compat.c duplicate definitions"
          
          git push origin vic
          echo "‚úÖ Pushed corrected integration"
